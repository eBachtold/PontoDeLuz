{% extends "base.html" %}
{% block content %}

<h3>Nova Venda</h3>

<form method="post">

  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Cliente</label>
      <input class="form-control mb-2" name="cliente" placeholder="Nome do cliente">
    </div>

    <div class="col-md-6">
      <label class="form-label">Canal</label>
      <select class="form-control mb-2" name="canal">
        <option value="Shopee">Shopee</option>
        <option value="Mercado Livre">Mercado Livre</option>
        <option value="Whatsapp">Whatsapp</option>
        <option value="Instagram">Instagram</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
  </div>

  <div class="row mt-3">

    <div class="col-md-4">
      <label class="form-label">Referência / Código do produto</label>
      <input class="form-control mb-2" id="produto_codigo" name="produto_codigo" placeholder="Ex: COL-001">
      <small class="text-muted">Digite a referência para buscar automaticamente</small>
      <div id="produto_info" class="mt-2 text-primary fw-bold"></div>
    </div>

    <div class="col-md-4">
      <label class="form-label">Produto (opcional)</label>
      <select class="form-control mb-2" name="produto_id">
        <option value="">Selecione um produto</option>
        {% for p in produtos %}
          <option value="{{ p.id }}">{{ p.codigo }} - {{ p.nome }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">Use se não souber a referência.</small>
    </div>

    <div class="col-md-4">
      <label class="form-label">Quantidade</label>
      <input class="form-control mb-2" name="quantidade" type="number" min="1" value="1">
    </div>

  </div>

  <div class="row mt-3">
    <div class="col-md-4">
      <label class="form-label">Comissão do marketplace (R$)</label>
      <input class="form-control mb-2" name="comissao" type="text" placeholder="Ex: 5,90">
    </div>
  </div>

  <button type="submit" class="btn btn-success mt-3">Registrar venda</button>
</form>

<script>
const inputCodigo = document.getElementById("produto_codigo");
const infoProduto = document.getElementById("produto_info");
const selectProduto = document.querySelector("select[name='produto_id']");

let buscaTimeout = null;

inputCodigo.addEventListener("keyup", function () {
    const codigo = this.value.trim();

    clearTimeout(buscaTimeout);

    if (codigo.length < 3) {
        infoProduto.innerHTML = "";
        if (selectProduto) selectProduto.value = "";
        return;
    }

    buscaTimeout = setTimeout(() => {
        fetch(`/api/produto/${encodeURIComponent(codigo)}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === "ok") {
                    infoProduto.innerHTML =
                        `Produto: ${data.nome} <br> Preço: R$ ${data.preco.toFixed(2)} <br> Estoque: ${data.estoque}`;
                    if (selectProduto) selectProduto.value = data.id;
                } else {
                    infoProduto.innerHTML =
                        "<span class='text-danger'>Produto não encontrado</span>";
                    if (selectProduto) selectProduto.value = "";
                }
            })
            .catch((err) => {
                console.error("Erro ao buscar produto:", err);
                infoProduto.innerHTML =
                    "<span class='text-danger'>Erro ao buscar produto</span>";
            });
    }, 300);
});

document.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        const tag = event.target.tagName.toLowerCase();
        if (tag !== "button" && tag !== "select") {
            event.preventDefault();
            return false;
        }
    }
});
</script>

{% endblock %}

