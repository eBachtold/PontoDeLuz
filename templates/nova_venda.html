{% extends "base.html" %}
{% block content %}

<h3>Nova Venda</h3>

<form method="post">

  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Cliente</label>
      <input class="form-control mb-2" name="cliente" placeholder="Nome do cliente">
    </div>

    <div class="col-md-6">
      <label class="form-label">Canal</label>
      <select class="form-control mb-2" name="canal">
        <option value="Shopee">Shopee</option>
        <option value="Mercado Livre">Mercado Livre</option>
        <option value="Whatsapp">Whatsapp</option>
        <option value="Instagram">Instagram</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
  </div>

  <div class="row mt-3">
    <!-- üÜï Busca por refer√™ncia -->
    <div class="col-md-4">
  <label class="form-label">Refer√™ncia / C√≥digo do produto</label>
  <input class="form-control mb-2" id="produto_codigo" name="produto_codigo" placeholder="Ex: COL-001">
  <small class="text-muted">Digite a refer√™ncia para buscar automaticamente</small>

  <!-- √Årea onde vamos mostrar o resultado -->
  <div id="produto_info" class="mt-2 text-primary fw-bold"></div>
</div>

    <!-- Select antigo continua funcionando -->
    <div class="col-md-4">
      <label class="form-label">Produto (opcional)</label>
      <select class="form-control mb-2" name="produto_id">
        <option value="">Selecione um produto</option>
        {% for p in produtos %}
          <option value="{{ p.id }}">{{ p.codigo }} - {{ p.nome }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">Use se n√£o souber a refer√™ncia.</small>
    </div>

    <div class="col-md-4">
      <label class="form-label">Quantidade</label>
      <input class="form-control mb-2" name="quantidade" type="number" min="1" value="1">
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-4">
      <label class="form-label">Comiss√£o do marketplace (R$)</label>
      <input class="form-control mb-2" name="comissao" type="text" placeholder="Ex: 5,90">
    </div>
  </div>

    <button type="submit" class="btn btn-success mt-3">Registrar venda</button>

</form>

<script>
document.getElementById("produto_codigo").addEventListener("keyup", function() {
    const codigo = this.value.trim();

    if (codigo.length < 1) {
        document.getElementById("produto_info").innerHTML = "";
        return;
    }

    fetch(`/api/produto/${codigo}`)
        .then(r => {
            if (!r.ok) throw new Error();
            return r.json();
        })
        .then(data => {
            document.getElementById("produto_info").innerHTML =
                `Produto: ${data.nome} <br> Pre√ßo: R$ ${data.preco.toFixed(2)} <br> Estoque: ${data.estoque}`;

            // Preenche automaticamente o select oculto
            const select = document.querySelector("select[name='produto_id']");
            if (select) select.value = data.id;
        })
        .catch(() => {
            document.getElementById("produto_info").innerHTML =
                "<span class='text-danger'>Produto n√£o encontrado</span>";
        });
});
</script>

<script>
// Impede que ENTER envie o formul√°rio
document.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        const tag = event.target.tagName.toLowerCase();
        // S√≥ permite enter no bot√£o ou selects
        if (tag !== "button" && tag !== "select") {
            event.preventDefault();
            return false;
        }
    }
});
</script>



{% endblock %}
